# Portal Auctions API Documentation

**Version:** 1.0.0  
**Priority:** Phase 3 - Core Business  
**Organization Code:** ORG-DERALY-001  
**Depends on:** API_01_AUTHENTICATION.md, API_05_AUCTIONS.md, API_06_BID_ACTIVITY.md  
**Public Access:** Yes (No authentication required for browsing)

---

## Overview

Public-facing API for auction portal. Allows users to browse live auctions and place bids. Different from admin API - returns limited auction information and requires authentication only for bidding.

**Base URL:** `/api/v1/auctions/portal`

---

## Data Models

### PortalAuction (Public View - Limited)
```typescript
interface PortalAuction {
  id: string;
  title: string;
  description: string;
  category: string;
  condition: string;
  currentBid: number;
  reservePrice: number;
  endTime: Date;
  participantCount: number;
  images?: string[]; // Array of image URLs
  organizationCode: string;
}
```

---

## Endpoints

### Public Endpoints - Authentication

#### 0. Portal User Login (First Time Access)
**Endpoint:** `POST /api/v1/auth/portal-login`

**Description:** Portal user registration/login via Corporate ID/NIP. Auto-creates user if doesn't exist, or loads existing user if already registered.

**Request Body:**
```json
{
  "fullName": "John Doe",
  "corporateIdNip": "EMP-2026-001",
  "directorate": "Sales",
  "invitationCode": "PORT-DERALY-ABC123XYZ"
}
```

**Request Validation:**
| Field | Type | Required | Rules |
|-------|------|----------|-------|
| fullName | string | Yes | Min 3 chars, max 100 chars |
| corporateIdNip | string | Yes | Globally unique, alphanumeric |
| directorate | string | Yes | Must be valid directorate |
| invitationCode | string | Yes | Must be valid & tied to organization |

**Response (200 OK - Existing User):**
```json
{
  "success": true,
  "data": {
    "userId": "user-uuid-existing",
    "portalToken": "PORT_TOKEN_xxx_jwt_format",
    "expiresIn": 3600,
    "message": "User loaded successfully",
    "isNewUser": false
  }
}
```

**Response (201 Created - New User):**
```json
{
  "success": true,
  "data": {
    "userId": "user-uuid-new",
    "portalToken": "PORT_TOKEN_xxx_jwt_format",
    "expiresIn": 3600,
    "message": "User registered successfully",
    "isNewUser": true
  }
}
```

**Response (400 Bad Request):**
```json
{
  "success": false,
  "error": "Invalid invitation code",
  "code": "INVALID_INVITATION_CODE"
}
```

**Business Rules:**
- Check if user with same `corporateIdNip` + organization exists
- If exists: Load user, update name if different, generate new token
- If not exists: Create new user with ACTIVE status, generate token
- Portal token valid for 1 hour (3600 seconds)
- Invitation code must be valid & not deactivated (reusable, can be regenerated by admin)

**Error Codes:**
- `INVALID_INVITATION_CODE` - Code invalid or deactivated
- `INVALID_DIRECTORATE` - Directorate not found
- `INVALID_INPUT` - Missing or invalid field values

---

#### 1. Get All Portal Auctions (Live Only)
**Endpoint:** `GET /api/v1/auctions/portal/list`

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| category | string | Filter by category (optional) |
| page | number | Page number (default: 1) |
| limit | number | Items per page (default: 10) |
| sort | string | Field: endTime, currentBid (default: endTime) |
| order | string | asc or desc (default: asc) |

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "61f3d1d1-3c3a-4629-8ec5-3f53667148fb",
      "title": "Laptop ASUS ROG Gaming",
      "description": "High performance gaming laptop in excellent condition",
      "category": "Elektronik",
      "condition": "Sangat Baik",
      "currentBid": 8500000,
      "reservePrice": 7500000,
      "endTime": "2026-01-30T15:30:00Z",
      "participantCount": 12,
      "images": [
        "https://minio.example.com/auctions/image1.jpg",
        "https://minio.example.com/auctions/image2.jpg"
      ],
      "organizationCode": "ORG-DERALY-001"
    }
  ]
}
```

**Response (400 Bad Request):**
```json
{
  "success": false,
  "error": "Invalid category",
  "code": "INVALID_PARAMETER"
}
```

---

#### 2. Get Single Portal Auction
**Endpoint:** `GET /api/v1/auctions/portal/:auctionId`

**URL Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| auctionId | string | Auction ID |

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": "61f3d1d1-3c3a-4629-8ec5-3f53667148fb",
    "title": "Laptop ASUS ROG Gaming",
    "description": "High performance gaming laptop in excellent condition",
    "category": "Elektronik",
    "condition": "Sangat Baik",
    "currentBid": 8500000,
    "reservePrice": 7500000,
    "endTime": "2026-01-30T15:30:00Z",
    "participantCount": 12,
    "images": [
      "https://minio.example.com/auctions/image1.jpg",
      "https://minio.example.com/auctions/image2.jpg"
    ],
    "organizationCode": "ORG-DERALY-001"
  }
}
```

**Response (404 Not Found):**
```json
{
  "success": false,
  "error": "Auction not found",
  "code": "AUCTION_NOT_FOUND"
}
```

---

### Authenticated Endpoints (Portal User Only)

#### 3. Place Bid
**Endpoint:** `POST /api/v1/bids/place`

**Authentication:**
- Required: Portal Token (JWT from portal-login)
- Header: `Authorization: Bearer <PORTAL_TOKEN>`

**Headers:**
```
Authorization: Bearer <PORTAL_TOKEN>
Content-Type: application/json
```

**Request Body:**
```json
{
  "auctionId": "61f3d1d1-3c3a-4629-8ec5-3f53667148fb",
  "bidAmount": 9000000
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "id": "bid-uuid",
    "auctionId": "61f3d1d1-3c3a-4629-8ec5-3f53667148fb",
    "bidAmount": 9000000,
    "status": "CURRENT",
    "timestamp": "2026-01-28T10:30:00Z"
  }
}
```

**Response (400 Bad Request - Examples):**

Bid too low:
```json
{
  "success": false,
  "error": "Bid amount must be at least 8750000",
  "code": "BID_TOO_LOW"
}
```

Auction not live:
```json
{
  "success": false,
  "error": "Cannot bid on non-LIVE auction",
  "code": "AUCTION_NOT_LIVE"
}
```

User is seller:
```json
{
  "success": false,
  "error": "You cannot bid on your own auction",
  "code": "CANNOT_BID_OWN_AUCTION"
}
```

**Validation Rules:**
- bidAmount > currentBid
- bidAmount >= currentBid + bidIncrement
- Auction status must be LIVE or ENDING
- User cannot be the seller
- User account must be ACTIVE
- Auction must not have ended

**Business Rules:**
- Automatically sets bid status to CURRENT
- Marks previous highest bid as OUTBID
- Updates auction's currentBid, totalBids, participantCount
- Logs bid activity
- Sends notifications to previous bidder (outbid) and seller
- Uses database transaction (atomic operation)

**Rate Limiting:**
- 10 bids per minute per user

**Response Codes:**
- `201 Created` - Bid placed successfully
- `400 Bad Request` - Validation error
- `401 Unauthorized` - User not authenticated
- `403 Forbidden` - User not allowed (seller, inactive)
- `404 Not Found` - Auction not found
- `429 Too Many Requests` - Rate limit exceeded

---

## Error Codes

| Code | HTTP | Description |
|------|------|-------------|
| `AUCTION_NOT_FOUND` | 404 | Auction doesn't exist |
| `BID_TOO_LOW` | 400 | Bid below minimum increment |
| `AUCTION_NOT_LIVE` | 400 | Cannot bid on non-LIVE auction |
| `CANNOT_BID_OWN_AUCTION` | 403 | User is seller of this auction |
| `ACCOUNT_INACTIVE` | 403 | User account not active |
| `BID_AFTER_END` | 400 | Auction already ended |
| `RATE_LIMIT_EXCEEDED` | 429 | Too many bids per minute |
| `INVALID_PARAMETER` | 400 | Invalid query parameter |
| `UNAUTHORIZED` | 401 | Missing or invalid token |

---

## Category Filter

Supported categories for filtering:
- Elektronik
- Jam Tangan
- Furniture
- Fotografi
- Seni
- Perhiasan
- Koleksi
- Lainnya

---

## Implementation Notes

### Frontend Service (bidService.ts)

The frontend has a dedicated `bidService` that handles:
- `getAllBidActivity()` - Get bid activity with filters
- `getBidsForAuction(auctionId)` - Get bids for specific auction
- `placeBid(auctionId, bidAmount)` - Place a new bid (requires auth)
- `getUserBidHistory(userId)` - Get user's bid history

### Portal Frontend Integration

Portal uses `auctionService.getAllPortalAuctions()` to load live auctions and `bidService.placeBid()` to submit bids through the `AuctionModal` component.

### Session Management

Portal includes local session management for unauthenticated user registration:
- Session stored in localStorage
- Auto-logout after 30 minutes of inactivity
- User info: fullName, corporateIdNip, directorate, organizationCode

---

## Example Flow

1. **User browses auctions** → `GET /api/v1/auctions/portal/list`
2. **User views auction details** → `GET /api/v1/auctions/portal/:auctionId`
3. **User places bid** (if authenticated) → `POST /api/v1/bids/place`
4. **Bid confirmed** → Auction updates with new currentBid and participantCount
